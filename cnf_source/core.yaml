AWSTemplateFormatVersion: 2010-09-09
Description: Core template. Contains network and iam roles
Parameters:
  VpcCidr:
    Type: String
    AllowedPattern: (\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/(\d{1,2})
    Default: "10.0.0.0/16"
  Environment:
    Type: String
    AllowedValues: [ prod, test ]
    Default: prod
Conditions:
  ProdEnv: !Equals [ !Ref Environment, prod ]
Resources:
  Vpc:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidr
      # Indicates whether the instances launched in the VPC get DNS hostnames.
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Join
            - "-"
            - [ !Ref Environment, vpc ]
  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      CidrBlock: !Select
        - 0
        - !Cidr [ !Ref VpcCidr, 12, 8 ]
      VpcId: !Ref Vpc
      MapPublicIpOnLaunch: true
      AvailabilityZone: !Select
        - 0
        - Fn::GetAZs: !Ref AWS::Region
      Tags:
        - Key: Name
          Value: !Join
            - "-"
            - [ !Ref Environment, public-subnet01 ]
        - Key: Env
          Value: !Ref Environment
        - Key: Private
          Value: false
  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      CidrBlock: !Select
        - 1
        - !Cidr [ !Ref VpcCidr, 12, 8 ]
      VpcId: !Ref Vpc
      MapPublicIpOnLaunch: true
      AvailabilityZone: !Select
        - 1
        - Fn::GetAZs: !Ref AWS::Region
      Tags:
        - Key: Name
          Value: !Join
            - "-"
            - [ !Ref Environment, public-subnet02 ]
        - Key: Env
          Value: !Ref Environment
        - Key: Private
          Value: false
  PublicSubnet3:
    Type: AWS::EC2::Subnet
    Properties:
      CidrBlock: !Select
        - 2
        - !Cidr [ !Ref VpcCidr, 12, 8 ]
      VpcId: !Ref Vpc
      MapPublicIpOnLaunch: true
      AvailabilityZone: !Select
        - 2
        - Fn::GetAZs: !Ref AWS::Region
      Tags:
        - Key: Name
          Value: !Join
            - "-"
            - [ !Ref Environment, public-subnet03 ]
        - Key: Env
          Value: !Ref Environment
        - Key: Private
          Value: false
  WebTierSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      CidrBlock: !Select
        - 3
        - !Cidr [ !Ref VpcCidr, 12, 8 ]
      VpcId: !Ref Vpc
      MapPublicIpOnLaunch: true
      AvailabilityZone: !Select
        - 0
        - Fn::GetAZs: !Ref AWS::Region
      Tags:
        - Key: Name
          Value: !Join
            - "-"
            - [ !Ref Environment, webtier-subnet01 ]
        - Key: Env
          Value: !Ref Environment
        - Key: Private
          Value: true
  WebTierSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      CidrBlock: !Select
        - 4
        - !Cidr [ !Ref VpcCidr, 12, 8 ]
      VpcId: !Ref Vpc
      AvailabilityZone: !Select
        - 1
        - Fn::GetAZs: !Ref AWS::Region
      Tags:
        - Key: Name
          Value: !Join
            - "-"
            - [ !Ref Environment, webtier-subnet02 ]
        - Key: Env
          Value: !Ref Environment
        - Key: Private
          Value: true
  WebTierSubnet3:
    Type: AWS::EC2::Subnet
    Properties:
      CidrBlock: !Select
        - 5
        - !Cidr [ !Ref VpcCidr, 12, 8 ]
      VpcId: !Ref Vpc
      AvailabilityZone: !Select
        - 2
        - Fn::GetAZs: !Ref AWS::Region
      Tags:
        - Key: Name
          Value: !Join
            - "-"
            - [ !Ref Environment, webtier-subnet03 ]
        - Key: Env
          Value: !Ref Environment
        - Key: Private
          Value: true
